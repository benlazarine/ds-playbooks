---
- import_playbook: prep_for_irods.yml


- name: test install resource server package
  hosts: rs:!ies:!unmanaged_systems
  become: true
  gather_facts: false
  tasks:
    - import_tasks: tasks/test_install_resource_pkg.yml
    - import_tasks: tasks/test_install_plugins.yml


- import_playbook: rule_templates.yml


- name: test irods config file placement
  hosts: rs
  become: true
  gather_facts: false
  tasks:
    - include_tasks: tasks/test_cfg_irods.yml

    - name: verify that clerver auth file exists
      stat:
        path: /var/lib/irods/.irods/.irodsA
      register: response
      failed_when: not response.stat.exists or response.stat.pw_name != 'irods'


- import_playbook: mk_storage_resources.yml
- import_playbook: mk_resource_hierarchies.yml


- name: test bring up all resources
  hosts: ies
  become: true
  become_user: irods
  gather_facts: false
  run_once: true
  tasks:
    - name: verify all resources are up
      command: |
        iquest '%s' "select count(RESC_ID) where RESC_STATUS != 'up' and RESC_NAME != 'bundleResc'"
      register: response
      changed_when: false
      failed_when: response.stdout != '0'
