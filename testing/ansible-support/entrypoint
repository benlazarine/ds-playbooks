#! /bin/bash

start()
{
  local cmd="$*"

  if [ -n "$cmd" ]
  then
    eval "$cmd" start
  fi

  /usr/sbin/sshd

  printf 'ready\n'
}


stop()
{
  local cmd="$*"

  kill -SIGTERM $(cat /var/run/sshd.pid)

  if [ -n "$cmd" ]
  then
    eval "$cmd" stop
  fi
}


main()
{
  local cmd="$*"

  start "$cmd"
  trap "kill \${!}; stop '$cmd'; exit \$?" SIGTERM

  while true
  do
    tail --follow /dev/null &
    wait ${!}
  done
}


set -e

main "$*"
