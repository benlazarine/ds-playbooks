---
- name: test configure firewall for iRODS resource server
  hosts: rs:!unmanaged_systems
  become: true
  tasks:
    - name: retrieve iptables contents
      slurp:
        src: /etc/sysconfig/iptables
      register: iptEncoded

    - name: decode iptables contents
      set_fact:
        iptables: "{{ iptEncoded | b64decode }}"

    - name: verify contents
      assert:
        that:
          - iptables is search('-A INPUT -m state --state NEW -p tcp -s 0.0.0.0/0 --dport 1247 -j ACCEPT' | regex_escape)

- name: verify that IES wasn't touched
  hosts: ies
  become: true
  tasks:
    - name: verify that irods isn't a group
      shell: |
        if grep --quiet --regexp '^irods:' /etc/group
        then
          exit 1
        fi
      changed_when: false

- name: verify that the RS system user hasn't changed
  hosts: rs
  become: true
  tasks:
    - name: verify that the system user has correct comment
      command: grep --quiet --regexp '^irods:[^:]*:[^:]*:[^:]*:iRODS Administrator:' /etc/passwd
      changed_when: false

- import_playbook: mk_vaults.yml
- import_playbook: install_resource_pkg.yml
