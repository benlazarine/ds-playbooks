---
- name: test begin IES upgrade
  hosts: ies:!unmanaged_systems
  become: true
  tasks:
    - name: test database plugin RPM updated
      yum:
        list: "{{
          'irods-database-plugin-postgres93'
            if inventory_hostname == 'dstesting_ies_centos6_1.dstesting_default' else
          'irods-database-plugin-postgres' }}"
      register: result
      failed_when: |
        result.results is not defined or
        result.results|count != 1 or
        result.results[0].version is version_compare('1.10', '!=')

    - name: test ICAT RPM updated
      yum:
        list: irods-icat
      register: result
      failed_when: |
        result.results is not defined or
        result.results|count != 1 or
        result.results[0].version is version_compare('4.1.10', '!=')


- name: test upgrade resource server package
  hosts: rs:!ies:!unmanaged_systems
  become: true
  tasks:
    - import_tasks: tasks/test_install_resource_pkg.yml


- name: test upgrade plugins
  hosts: irods:!unmanaged_systems
  become: true
  gather_facts: false
  tasks:
    - import_tasks: tasks/test_install_plugins.yml


- import_playbook: restart_all.yml
