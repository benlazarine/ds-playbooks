---
- name: test the default variables populate the configs correctly
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../defaults/main.yml
    - ../vars/main.yml
  vars:
    aegis_env: "{{ lookup('template', '../templates/aegis-env.re.j2') }}"
    bisque_env: "{{ lookup('template', '../templates/bisque-env.re.j2') }}"
    ipc_env: "{{ lookup('template', '../templates/ipc-env.re.j2') }}"
    sernec_env: "{{ lookup('template', '../templates/sernec-env.re.j2') }}"
  tasks:
    - name: verify constants expand correctly in ipc-env.re.j2
      assert:
        that:
          - ipc_env | search("ipc_AMQP_EPHEMERAL = true")
          - ipc_env | search("ipc_DEFAULT_REPL_RESC = 'demoResc'")
          - ipc_env | search("ipc_RE_HOST = 'localhost'")
          - ipc_env | search("ipc_MAX_NUM_RE_PROCS = 4")

    - name: verify constants expand correctly in aegis-env.re.j2
      assert:
        that:
          - aegis_env | search("aegis_INGEST_RESC = 'aegisIngestRes'")
          - aegis_env | search("aegis_REPL_RESC = 'aegisReplRes'")

    - name: verify constants expand correctly in bisque-env.re.j2
      assert:
        that:
          - bisque_env | search("bisque_IRODS_URL_BASE = 'irods://localhost'")

    - name: verify sernec constants expand correctly in sernec-env.re.j2
      assert:
        that:
         - sernec_env | search('sernec_OWNERS = list()' | regex_escape)
         - sernec_env | search('sernec_WRITERS = list()' | regex_escape)
         - sernec_env | search('sernec_READERS = list()' | regex_escape)


- name: test aegis params are set correctly
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../defaults/main.yml
    - vars/aegis_opts.yml
    - ../vars/main.yml
  vars:
    aegis_env: "{{ lookup('template', '../templates/aegis-env.re.j2') }}"
  tasks:
    - name: verify params
      assert:
        that:
          - aegis_env | search("aegis_INGEST_RESC = 'aegisIngest'")
          - aegis_env | search("aegis_REPL_RESC = 'aegisReplication'")

- name: test that ipc_MAX_NUM_RE_PROCS set correctly in ipc-env.re
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../defaults/main.yml
    - vars/max_num_re_procs.yml
    - ../vars/main.yml
  vars:
    ipc_env: "{{ lookup('template', '../templates/ipc-env.re.j2') }}"
  tasks:
    - name: verify ipc_MAX_NUM_RE_PROCS
      assert:
        that:
          - ipc_env | search("ipc_MAX_NUM_RE_PROCS = 1")

- name: test that single threaded resources are correctly added to ipc-env.re
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../defaults/main.yml
    - vars/single_threaded_resources.yml
    - ../vars/main.yml
  vars:
    ipc_env: "{{ lookup('template', '../templates/ipc-env.re.j2') }}"
  tasks:
    - name: verify acSetNumThreads defined correctly in ipc-env.re
      assert:
        that:
          - ipc_env | search("ON($rescName == 'resource-1' && $clientAddr == ipc_IES_IP)" | regex_escape)
          - ipc_env | search("ON($rescName == 'resource-2' && $clientAddr == ipc_IES_IP)" | regex_escape)

- name: test that bisque-env.re gets generated correctly with a bisque iRODS host is provided
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../defaults/main.yml
    - vars/bisque_irods_host.yml
    - ../vars/main.yml
  vars:
    bisque_env: "{{ lookup('template', '../templates/bisque-env.re.j2') }}"
  tasks:
    - name: verify bisque_env
      assert:
        that:
         - bisque_env | search("bisque_IRODS_URL_BASE = 'irods://custom.irods.host'")

- name: test that sernec perm groups are generated correctly
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../defaults/main.yml
    - vars/sernec_perms.yml
    - ../vars/main.yml
  vars:
    sernec_env: "{{ lookup('template', '../templates/sernec-env.re.j2') }}"
  tasks:
    - name: verify sernec_env
      assert:
        that:
         - sernec_env | search('sernec_OWNERS = list("own1", "own2")' | regex_escape)
         - sernec_env | search('sernec_WRITERS = list("write1", "write2")' | regex_escape)
         - sernec_env | search('sernec_READERS = list("read1", "read2")' | regex_escape)
