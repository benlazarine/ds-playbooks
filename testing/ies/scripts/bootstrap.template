#! /bin/bash

set -e


terminate()
{
  /var/lib/irods/iRODS/irodsctl stop
  exit "$?"
}


until exec 3<> /dev/tcp/"$DBMS_HOST"/"$DBMS_PORT"
do
  printf 'Waiting for DBMS\n'
  sleep 1
done 2> /dev/null

exec 3<&-
exec 3>&-

if ! /var/lib/irods/iRODS/irodsctl start
then
  cat /var/lib/irods/iRODS/server/log/rodsLog* >&2
  exit 1
fi

trap 'kill ${!}; terminate' SIGTERM

printf 'Authenticating clerver user\n'
iinit "$IRODS_ZONE_PASSWORD"

printf 'done\n'

while true
do
  tail --follow /dev/null &
  wait ${!}
done
